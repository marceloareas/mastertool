<section class="single-class">
	<div class="bar__top">
		<div class="bar__top__content">
			<button mat-icon-button (click)="closeClass()">
				<mat-icon>arrow_back</mat-icon>
			</button>
			<h2>{{ class.nome }}</h2>
			<h3>{{ class.periodo }}</h3>
		</div>
		<div class="bar__top__button">
			<button mat-stroked-button
				(click)="openModalStudent()">
				Adicionar Aluno
			</button>
			<button mat-stroked-button
				(click)="openModalClass(class, 'EDIT')">
				Editar turma
			</button>
			<div class="bar__top__button">
				<button mat-stroked-button
					(click)="promptRemoveColumns()"
					[disabled]="!hasAlunos"
					[matTooltip]="!hasAlunos ? 'Adicione alunos para descartar menor nota' : ''">
					Descartar menor nota
				</button>

				<button mat-flat-button color="primary"
					(click)="exportReport('resumido')"
					[disabled]="!hasAlunos || mode == 'EDIT'"
					[matTooltip]="!hasAlunos ? 'Adicione alunos para exportar relatório' : ''">Exportar
					CSV Resumido</button>

				<button mat-flat-button color="primary"
					(click)="exportReport('detalhado')"
					[disabled]="!hasAlunos || mode == 'EDIT'"
					[matTooltip]="!hasAlunos ? 'Adicione alunos para exportar relatório' : ''">Exportar
					CSV Detalhado</button>
			</div>

		</div>
	</div>

	<div class="single-class__top">
		<div class="action-button">
			@if(mode === 'VIEW') {
			<!-- Não vejo sentido desse botão, faz mais sentido add nota ao entrar no modo de edição -->
			<!-- <button mat-stroked-button style="margin-left: 20px; margin-right: 20px;"
				color="primary"
				(click)="changeMode('EDIT');addNewColumn();"
				[disabled]="!hasAlunos"
				[matTooltip]="!hasAlunos ? 'Adicione alunos para adicionar notas' : ''">
				Adicionar Nota
			</button> -->

			<button mat-flat-button color="primary"
				(click)="changeMode('EDIT')"
				[disabled]="!hasAlunos"
				[matTooltip]="!hasAlunos ? 'Adicione alunos para editar notas' : ''">
				Editar Notas
			</button>
			} @else {
			<div class="edit-mode-buttons"
				style="margin-left: 20px; margin-right: 20px;">
				<button mat-stroked-button color="primary"
					(click)="addNewColumn()"
					[disabled]="!hasAlunos"
					[matTooltip]="!hasAlunos ? 'Adicione alunos para adicionar notas' : ''">
					Adicionar Nota
				</button>
				<div class="confirm-buttons">
					<button mat-stroked-button (click)="changeMode('VIEW');">Cancelar</button>
					<button mat-flat-button color="primary" (click)="save()">Salvar</button>
				</div>
			</div>
			}
		</div>
	</div>

	<table mat-table [dataSource]="this.class.alunos" class="mat-elevation-z8">
		<!-- Coluna de Nomes dos Alunos -->
		<ng-container matColumnDef="nome">
			<th mat-header-cell *matHeaderCellDef width="200px">Alunos</th>
			<td mat-cell *matCellDef="let element">{{ element.matricula }} - {{
				element.nome }}</td>
		</ng-container>

		<!-- Cabaçalho de Notas Dinâmico -->
		@for(notaCol of notaColumns; track notaCol ){
		<ng-container [matColumnDef]="notaCol">
			<th mat-header-cell *matHeaderCellDef width="100px">
				<div class="header-cell">
					<!-- Titulo da Coluna - Ex: P1 -->
					<input matInput type="text" placeholder="Digite o nome"
						[ngClass]="mode === 'EDIT' ? 'edit' : ''" [value]="notaCol"
						(blur)="updateColumnName($event, $index)" [disabled]="mode === 'VIEW'" />

					<!-- Peso -->
					<span style="margin-left: 10px">Peso</span>
					<input matInput type="number" style="width: 30px; margin-right: 20px"
						placeholder="Peso" [value]="getPeso(notaCol)"
						(input)="updatePeso($event, notaCol)" [disabled]="mode === 'VIEW'" />

					@if(mode !== 'VIEW'){
					<!-- Botão para remoção de coluna -->
					<button mat-icon-button class="button__delete"
						(click)="removeColumn(notaCol)"> <mat-icon class="icon__delete"
							fontIcon="delete"></mat-icon> </button>
					}
				</div>
			</th>
			<td mat-cell *matCellDef="let element">
				<input matInput type="number"
					[ngClass]="mode === 'EDIT' ? 'edit' : ''"
					[value]="element.notas[$index]?.valor"
					(input)="updateNota($event, element, notaCol)"
					[disabled]="mode === 'VIEW'" />
			</td>
		</ng-container>
		}

		<!-- Média Column -->
		<ng-container matColumnDef="media">
			<th mat-header-cell *matHeaderCellDef width="50px">Média</th>
			<td mat-cell *matCellDef="let element">{{ media(element) }}</td>
		</ng-container>

		<!-- Ações Column -->
		<ng-container matColumnDef="editar">
			<th mat-header-cell *matHeaderCellDef class="action-header" mat-sort-header
				width="60px"> Ações </th>

			<td mat-cell *matCellDef="let element" class="action-cell">

				<button mat-icon-button [matMenuTriggerFor]="menu">
					<mat-icon fontIcon="more_vert"></mat-icon>
				</button>

				<mat-menu #menu="matMenu">
					<button mat-menu-item
						(click)="deleteStudent(element.matricula)">
						<mat-icon fontIcon="delete"></mat-icon> Remover
					</button>
				</mat-menu>

			</td>
		</ng-container>

		<!-- Header and Row Definitions -->
		<tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
		<tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
	</table>

	<mat-paginator
		[pageSizeOptions]="[1, 5, 7]"
		showFirstLastButtons
		aria-label="Select page of periodic elements"></mat-paginator>
</section>
